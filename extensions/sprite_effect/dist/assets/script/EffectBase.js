"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EffectBase = void 0;
const cc_1 = require("cc");
const cc_2 = require("cc");
const cc_3 = require("cc");
const cc_4 = require("cc");
const cc_5 = require("cc");
const env_1 = require("cc/env");
const { ccclass, requireComponent, executeInEditMode, property } = cc_5._decorator;
let EffectBase = class EffectBase extends cc_5.Component {
    constructor() {
        super(...arguments);
        this.effectAsset = null;
        this._is2Din3D = false;
        //#endregion
        this._sprite = null;
        this._isDirty = false;
        this._reload = false;
        this._params = new Map();
        this._isParamsDirty = false;
    }
    //#region is2Din3D
    get is2Din3D() {
        return this._is2Din3D;
    }
    set is2Din3D(val) {
        this._is2Din3D = val;
        this._is2Din3DChanged(this._is2Din3D);
    }
    //#endregion
    //#region reloadEffect
    get reloadEffect() {
        return this._reload;
    }
    set reloadEffect(val) {
        this._reload = val;
        this.reloadTsFile();
    }
    async reloadTsFile() {
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            const reloadTsFile_000 = await Editor.Message.request("asset-db", "reimport-asset", "853e8fbf-9769-49a8-b2d2-0016390b6953");
        }
    }
    ;
    autoAssignEffectAsset() {
        if (env_1.EDITOR_NOT_IN_PREVIEW && this.effectAsset === null) {
            setTimeout(async () => {
                try {
                    const uuids = Editor.Selection.getSelected('node');
                    const node = await Editor.Message.request('scene', 'query-node', uuids[0]);
                    if (!node) {
                        console.warn(`未選中節點`);
                        return;
                    }
                    const effectCompName = this.constructor.name;
                    const index = node.__comps__.findIndex((v) => v.type === effectCompName);
                    if (index === -1) {
                        console.warn(`節點未掛載${effectCompName}組件`);
                        return;
                    }
                    const effectFileName = effectCompName.replace(/([A-Z])/g, '_$1').toLowerCase().slice(1);
                    const url = `db://sprite_effect/effect/${effectFileName}.effect`;
                    const res = await Editor.Message.request('asset-db', 'query-asset-info', url);
                    const uuid = res.uuid;
                    const success = await Editor.Message.request('scene', 'set-property', {
                        uuid: node.uuid.value,
                        path: `__comps__.${index}.effectAsset`,
                        dump: {
                            type: 'cc.EffectAsset',
                            value: {
                                uuid,
                            },
                        },
                    });
                    if (success) {
                        console.log(`Effect自動掛載成功`);
                        await this.reloadTsFile();
                    }
                    else {
                        console.log(`Effect自動掛載失敗`);
                    }
                }
                catch (ex) {
                    console.error(`autoAssignEffectAsset: ${ex}`);
                }
            }, 100);
        }
    }
    onLoad() {
        this._sprite = this.getComponent(cc_4.Sprite);
        this._instMaterial();
    }
    start() {
        this.autoAssignEffectAsset();
    }
    update(dt) {
        if (this._isParamsDirty) {
            this._params.forEach((val, key) => {
                if (val.is_dirty) {
                    this._updateParams(val.key, val.idx);
                    val.is_dirty = false;
                }
            });
            this._isParamsDirty = false;
        }
    }
    /**
     * @virtual
     * @description: 當Sprite被用在3D時(掛載RenderRoot2D時)，需要開啟深度測試才能正確顯示深度
     */
    _is2Din3DChanged(enable) {
        this._instMaterial();
    }
    _setParams(key, idx) {
        this._params.set(key, { key: key, idx: idx, is_dirty: true });
        this._isParamsDirty = true;
    }
    _setParamsDirty(key) {
        if (this._params.has(key)) {
            this._params.get(key).is_dirty = true;
            this._isParamsDirty = true;
        }
        else {
            cc_1.log(`EffectBase._setParamsDirty: key ${key} not found`);
        }
    }
    _getUV(uv) {
        let minU = Math.min(uv[0], uv[2], uv[4], uv[6]);
        let minV = Math.min(uv[1], uv[3], uv[5], uv[7]);
        let maxU = Math.max(uv[0], uv[2], uv[4], uv[6]);
        let maxV = Math.max(uv[1], uv[3], uv[5], uv[7]);
        let width = maxU - minU;
        let height = maxV - minV;
        return new cc_3.Vec4(minU, minV, width, height);
    }
};
__decorate([
    property({ type: cc_1.EffectAsset, tooltip: '指定效果EffectAsset' })
], EffectBase.prototype, "effectAsset", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, tooltip: '當使用RenderRoot2D時使用' })
], EffectBase.prototype, "is2Din3D", null);
__decorate([
    property({ group: { name: "Private Props", id: "1" }, visible: true, tooltip: '當使用RenderRoot2D時使用' })
], EffectBase.prototype, "_is2Din3D", void 0);
__decorate([
    property({ type: cc_2.CCBoolean, tooltip: '手動刷新，當效果在Editor沒有顯示時' })
], EffectBase.prototype, "reloadEffect", null);
EffectBase = __decorate([
    ccclass('EffectBase'),
    requireComponent(cc_4.Sprite),
    executeInEditMode(true)
], EffectBase);
exports.EffectBase = EffectBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWZmZWN0QmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS9hc3NldHMvc2NyaXB0L0VmZmVjdEJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsMkJBQTRDO0FBQzVDLDJCQUErQjtBQUMvQiwyQkFBMEI7QUFDMUIsMkJBQTRCO0FBQzVCLDJCQUFpRDtBQUNqRCxnQ0FBNEQ7QUFFNUQsTUFBTSxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsR0FBRyxlQUFVLENBQUM7QUFLOUUsSUFBc0IsVUFBVSxHQUFoQyxNQUFzQixVQUFXLFNBQVEsY0FBUztJQUFsRDs7UUFFVyxnQkFBVyxHQUF1QixJQUFJLENBQUM7UUFjcEMsY0FBUyxHQUFZLEtBQUssQ0FBQztRQW9FckMsWUFBWTtRQUVGLFlBQU8sR0FBa0IsSUFBSSxDQUFDO1FBQzlCLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFDNUIsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUN6QixZQUFPLEdBQWlFLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEYsbUJBQWMsR0FBWSxLQUFLLENBQUM7SUFzRTVDLENBQUM7SUE1Skcsa0JBQWtCO0lBRWxCLElBQVcsUUFBUTtRQUNmLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBVyxRQUFRLENBQUMsR0FBWTtRQUM1QixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFJRCxZQUFZO0lBR1osc0JBQXNCO0lBRXRCLElBQVksWUFBWTtRQUNwQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQVksWUFBWSxDQUFDLEdBQVk7UUFDakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7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QUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUM7MENBR3RGO0FBUUQ7SUFEQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDOzZDQUNqRTtBQU1yQztJQURDLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxjQUFTLEVBQUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLENBQUM7OENBRzlEO0FBeEJpQixVQUFVO0lBSC9CLE9BQU8sQ0FBQyxZQUFZLENBQUM7SUFDckIsZ0JBQWdCLENBQUMsV0FBTSxDQUFDO0lBQ3hCLGlCQUFpQixDQUFDLElBQUksQ0FBQztHQUNGLFVBQVUsQ0FnSy9CO0FBaEtxQixnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVmZmVjdEFzc2V0LCBnYW1lLCBsb2cgfSBmcm9tICdjYyc7XG5pbXBvcnQgeyBDQ0Jvb2xlYW4gfSBmcm9tICdjYyc7XG5pbXBvcnQgeyBWZWM0IH0gZnJvbSAnY2MnO1xuaW1wb3J0IHsgU3ByaXRlIH0gZnJvbSAnY2MnO1xuaW1wb3J0IHsgX2RlY29yYXRvciwgQ29tcG9uZW50LCBOb2RlIH0gZnJvbSAnY2MnO1xuaW1wb3J0IHsgREVWLCBFRElUT1IsIEVESVRPUl9OT1RfSU5fUFJFVklFVyB9IGZyb20gJ2NjL2Vudic7XG5cbmNvbnN0IHsgY2NjbGFzcywgcmVxdWlyZUNvbXBvbmVudCwgZXhlY3V0ZUluRWRpdE1vZGUsIHByb3BlcnR5IH0gPSBfZGVjb3JhdG9yO1xuXG5AY2NjbGFzcygnRWZmZWN0QmFzZScpXG5AcmVxdWlyZUNvbXBvbmVudChTcHJpdGUpXG5AZXhlY3V0ZUluRWRpdE1vZGUodHJ1ZSlcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFZmZlY3RCYXNlIGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgICBAcHJvcGVydHkoeyB0eXBlOiBFZmZlY3RBc3NldCwgdG9vbHRpcDogJ+aMh+WumuaViOaenEVmZmVjdEFzc2V0JyB9KVxuICAgIHB1YmxpYyBlZmZlY3RBc3NldDogRWZmZWN0QXNzZXQgfCBudWxsID0gbnVsbDtcblxuICAgIC8vI3JlZ2lvbiBpczJEaW4zRFxuICAgIEBwcm9wZXJ0eSh7IGdyb3VwOiB7IG5hbWU6IFwiU2V0dGVyL0dldHRlclwiLCBpZDogXCIxXCIgfSwgdG9vbHRpcDogJ+eVtuS9v+eUqFJlbmRlclJvb3QyROaZguS9v+eUqCcgfSlcbiAgICBwdWJsaWMgZ2V0IGlzMkRpbjNEKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXMyRGluM0Q7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBpczJEaW4zRCh2YWw6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5faXMyRGluM0QgPSB2YWw7XG4gICAgICAgIHRoaXMuX2lzMkRpbjNEQ2hhbmdlZCh0aGlzLl9pczJEaW4zRCk7XG4gICAgfVxuXG4gICAgQHByb3BlcnR5KHsgZ3JvdXA6IHsgbmFtZTogXCJQcml2YXRlIFByb3BzXCIsIGlkOiBcIjFcIiB9LCB2aXNpYmxlOiB0cnVlLCB0b29sdGlwOiAn55W25L2/55SoUmVuZGVyUm9vdDJE5pmC5L2/55SoJyB9KVxuICAgIHByb3RlY3RlZCBfaXMyRGluM0Q6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAvLyNlbmRyZWdpb25cblxuXG4gICAgLy8jcmVnaW9uIHJlbG9hZEVmZmVjdFxuICAgIEBwcm9wZXJ0eSh7IHR5cGU6IENDQm9vbGVhbiwgdG9vbHRpcDogJ+aJi+WLleWIt+aWsO+8jOeVtuaViOaenOWcqEVkaXRvcuaykuaciemhr+ekuuaZgicgfSlcbiAgICBwcml2YXRlIGdldCByZWxvYWRFZmZlY3QoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZWxvYWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXQgcmVsb2FkRWZmZWN0KHZhbDogYm9vbGVhbikge1xuICAgICAgICB0aGlzLl9yZWxvYWQgPSB2YWw7XG4gICAgICAgIHRoaXMucmVsb2FkVHNGaWxlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyByZWxvYWRUc0ZpbGUoKSB7XG4gICAgICAgIGlmIChFRElUT1JfTk9UX0lOX1BSRVZJRVcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbG9hZFRzRmlsZV8wMDAgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KFwiYXNzZXQtZGJcIiwgXCJyZWltcG9ydC1hc3NldFwiLCBcIjg1M2U4ZmJmLTk3NjktNDlhOC1iMmQyLTAwMTYzOTBiNjk1M1wiKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIGF1dG9Bc3NpZ25FZmZlY3RBc3NldCgpIHtcbiAgICAgICAgaWYgKEVESVRPUl9OT1RfSU5fUFJFVklFVyAmJiB0aGlzLmVmZmVjdEFzc2V0ID09PSBudWxsKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1dWlkcyA9IEVkaXRvci5TZWxlY3Rpb24uZ2V0U2VsZWN0ZWQoJ25vZGUnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ3F1ZXJ5LW5vZGUnLCB1dWlkc1swXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGDmnKrpgbjkuK3nr4Dpu55gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVmZmVjdENvbXBOYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IG5vZGUuX19jb21wc19fLmZpbmRJbmRleCgodjogYW55KSA9PiB2LnR5cGUgPT09IGVmZmVjdENvbXBOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGDnr4Dpu57mnKrmjpvovIkke2VmZmVjdENvbXBOYW1lfee1hOS7tmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0RmlsZU5hbWUgPSBlZmZlY3RDb21wTmFtZS5yZXBsYWNlKC8oW0EtWl0pL2csICdfJDEnKS50b0xvd2VyQ2FzZSgpLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSBgZGI6Ly9zcHJpdGVfZWZmZWN0L2VmZmVjdC8ke2VmZmVjdEZpbGVOYW1lfS5lZmZlY3RgO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdhc3NldC1kYicsICdxdWVyeS1hc3NldC1pbmZvJywgdXJsKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1dWlkID0gcmVzIS51dWlkO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnc2NlbmUnLCAnc2V0LXByb3BlcnR5Jywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXVpZDogbm9kZS51dWlkLnZhbHVlIGFzIHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IGBfX2NvbXBzX18uJHtpbmRleH0uZWZmZWN0QXNzZXRgLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHVtcDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjYy5FZmZlY3RBc3NldCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBFZmZlY3Toh6rli5XmjpvovInmiJDlip9gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVsb2FkVHNGaWxlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgRWZmZWN06Ieq5YuV5o6b6LyJ5aSx5pWXYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBhdXRvQXNzaWduRWZmZWN0QXNzZXQ6ICR7ZXh9YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyNlbmRyZWdpb25cblxuICAgIHByb3RlY3RlZCBfc3ByaXRlOiBTcHJpdGUgfCBudWxsID0gbnVsbDtcbiAgICBwcm90ZWN0ZWQgX2lzRGlydHk6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIF9yZWxvYWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIF9wYXJhbXM6IE1hcDxzdHJpbmcsIHsga2V5OiBzdHJpbmcsIGlkeDogbnVtYmVyLCBpc19kaXJ0eTogYm9vbGVhbiB9PiA9IG5ldyBNYXAoKTtcbiAgICBwcml2YXRlIF9pc1BhcmFtc0RpcnR5OiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBwcm90ZWN0ZWQgb25Mb2FkKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9zcHJpdGUgPSB0aGlzLmdldENvbXBvbmVudChTcHJpdGUpO1xuICAgICAgICB0aGlzLl9pbnN0TWF0ZXJpYWwoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc3RhcnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXV0b0Fzc2lnbkVmZmVjdEFzc2V0KCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHVwZGF0ZShkdDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLl9pc1BhcmFtc0RpcnR5KSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMuZm9yRWFjaCgodmFsLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodmFsLmlzX2RpcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBhcmFtcyh2YWwua2V5LCB2YWwuaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgdmFsLmlzX2RpcnR5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLl9pc1BhcmFtc0RpcnR5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAdmlydHVhbFxuICAgICAqIEBkZXNjcmlwdGlvbjog5a6e5L6L5YyW5p2Q6LSoXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IF9pbnN0TWF0ZXJpYWwoKTogdm9pZDtcblxuICAgIC8qKlxuICAgICAqIEB2aXJ0dWFsXG4gICAgICogQGRlc2NyaXB0aW9uOiDmm7TmlrDmnZDotKjlj4LmlbBcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgX3VwZGF0ZVBhcmFtcyhrZXk6IHN0cmluZywgaWR4OiBudW1iZXIpOiB2b2lkO1xuXG4gICAgLyoqXG4gICAgICogQHZpcnR1YWxcbiAgICAgKiBAZGVzY3JpcHRpb246IOeVtlNwcml0Zeiiq+eUqOWcqDNE5pmCKOaOm+i8iVJlbmRlclJvb3QyROaZginvvIzpnIDopoHplovllZ/mt7HluqbmuKzoqabmiY3og73mraPnorrpoa/npLrmt7HluqZcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgX2lzMkRpbjNEQ2hhbmdlZChlbmFibGU6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5faW5zdE1hdGVyaWFsKCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9zZXRQYXJhbXMoa2V5OiBzdHJpbmcsIGlkeDogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuX3BhcmFtcy5zZXQoa2V5LCB7IGtleToga2V5LCBpZHg6IGlkeCwgaXNfZGlydHk6IHRydWUgfSk7XG4gICAgICAgIHRoaXMuX2lzUGFyYW1zRGlydHkgPSB0cnVlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfc2V0UGFyYW1zRGlydHkoa2V5OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BhcmFtcy5oYXMoa2V5KSkge1xuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLmdldChrZXkpIS5pc19kaXJ0eSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLl9pc1BhcmFtc0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGxvZyhgRWZmZWN0QmFzZS5fc2V0UGFyYW1zRGlydHk6IGtleSAke2tleX0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2dldFVWKHV2OiBudW1iZXJbXSk6IFZlYzQge1xuICAgICAgICBsZXQgbWluVSA9IE1hdGgubWluKHV2WzBdLCB1dlsyXSwgdXZbNF0sIHV2WzZdKTtcbiAgICAgICAgbGV0IG1pblYgPSBNYXRoLm1pbih1dlsxXSwgdXZbM10sIHV2WzVdLCB1dls3XSk7XG5cbiAgICAgICAgbGV0IG1heFUgPSBNYXRoLm1heCh1dlswXSwgdXZbMl0sIHV2WzRdLCB1dls2XSk7XG4gICAgICAgIGxldCBtYXhWID0gTWF0aC5tYXgodXZbMV0sIHV2WzNdLCB1dls1XSwgdXZbN10pO1xuXG4gICAgICAgIGxldCB3aWR0aCA9IG1heFUgLSBtaW5VO1xuICAgICAgICBsZXQgaGVpZ2h0ID0gbWF4ViAtIG1pblY7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBWZWM0KG1pblUsIG1pblYsIHdpZHRoLCBoZWlnaHQpO1xuICAgIH1cbn1cblxuXG4iXX0=