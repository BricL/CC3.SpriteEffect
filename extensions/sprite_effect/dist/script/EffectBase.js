"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EffectBase = void 0;
const cc_1 = require("cc");
const cc_2 = require("cc");
const cc_3 = require("cc");
const cc_4 = require("cc");
const cc_5 = require("cc");
const env_1 = require("cc/env");
const { ccclass, requireComponent, executeInEditMode, property } = cc_5._decorator;
let EffectBase = class EffectBase extends cc_5.Component {
    constructor() {
        super(...arguments);
        this.effectAsset = null;
        this._is2Din3D = false;
        //#endregion
        this._sprite = null;
        this._isDirty = false;
        this._reload = false;
        this._params = new Map();
        this._isParamsDirty = false;
    }
    //#region is2Din3D
    get is2Din3D() {
        return this._is2Din3D;
    }
    set is2Din3D(val) {
        this._is2Din3D = val;
        this._is2Din3DChanged(this._is2Din3D);
    }
    //#endregion
    //#region reloadEffect
    get reloadEffect() {
        return this._reload;
    }
    set reloadEffect(val) {
        this._reload = val;
        this.reloadTsFile();
    }
    async reloadTsFile() {
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            const reloadTsFile_000 = await Editor.Message.request("asset-db", "reimport-asset", "853e8fbf-9769-49a8-b2d2-0016390b6953");
        }
    }
    ;
    autoAssignEffectAsset() {
        if (env_1.EDITOR_NOT_IN_PREVIEW && this.effectAsset === null) {
            setTimeout(async () => {
                try {
                    const uuids = Editor.Selection.getSelected('node');
                    const node = await Editor.Message.request('scene', 'query-node', uuids[0]);
                    if (!node) {
                        console.warn(`未選中節點`);
                        return;
                    }
                    const effectCompName = this.constructor.name;
                    const index = node.__comps__.findIndex((v) => v.type === effectCompName);
                    if (index === -1) {
                        console.warn(`節點未掛載${effectCompName}組件`);
                        return;
                    }
                    const effectFileName = effectCompName.replace(/([A-Z])/g, '_$1').toLowerCase().slice(1);
                    const url = `db://sprite_effect/effect/${effectFileName}.effect`;
                    const res = await Editor.Message.request('asset-db', 'query-asset-info', url);
                    const uuid = res.uuid;
                    const success = await Editor.Message.request('scene', 'set-property', {
                        uuid: node.uuid.value,
                        path: `__comps__.${index}.effectAsset`,
                        dump: {
                            type: 'cc.EffectAsset',
                            value: {
                                uuid,
                            },
                        },
                    });
                    if (success) {
                        console.log(`Effect自動掛載成功`);
                        await this.reloadTsFile();
                    }
                    else {
                        console.log(`Effect自動掛載失敗`);
                    }
                }
                catch (ex) {
                    console.error(`autoAssignEffectAsset: ${ex}`);
                }
            }, 100);
        }
    }
    onLoad() {
        this._sprite = this.getComponent(cc_4.Sprite);
        this._instMaterial();
    }
    start() {
        this.autoAssignEffectAsset();
    }
    update(dt) {
        if (this._isParamsDirty) {
            this._params.forEach((val, key) => {
                if (val.is_dirty) {
                    this._updateParams(val.key, val.idx);
                    val.is_dirty = false;
                }
            });
            this._isParamsDirty = false;
        }
    }
    /**
     * @virtual
     * @description: 當Sprite被用在3D時(掛載RenderRoot2D時)，需要開啟深度測試才能正確顯示深度
     */
    _is2Din3DChanged(enable) {
        this._instMaterial();
    }
    _setParams(key, idx) {
        this._params.set(key, { key: key, idx: idx, is_dirty: true });
        this._isParamsDirty = true;
    }
    _setParamsDirty(key) {
        if (this._params.has(key)) {
            this._params.get(key).is_dirty = true;
            this._isParamsDirty = true;
        }
        else {
            cc_1.log(`EffectBase._setParamsDirty: key ${key} not found`);
        }
    }
    _getUV(uv) {
        let minU = Math.min(uv[0], uv[2], uv[4], uv[6]);
        let minV = Math.min(uv[1], uv[3], uv[5], uv[7]);
        let maxU = Math.max(uv[0], uv[2], uv[4], uv[6]);
        let maxV = Math.max(uv[1], uv[3], uv[5], uv[7]);
        let width = maxU - minU;
        let height = maxV - minV;
        return new cc_3.Vec4(minU, minV, width, height);
    }
};
__decorate([
    property({ type: cc_1.EffectAsset, tooltip: '指定效果EffectAsset' })
], EffectBase.prototype, "effectAsset", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, tooltip: '當使用RenderRoot2D時使用' })
], EffectBase.prototype, "is2Din3D", null);
__decorate([
    property({ group: { name: "Private Props", id: "1" }, visible: true, tooltip: '當使用RenderRoot2D時使用' })
], EffectBase.prototype, "_is2Din3D", void 0);
__decorate([
    property({ type: cc_2.CCBoolean, tooltip: '手動刷新，當效果在Editor沒有顯示時' })
], EffectBase.prototype, "reloadEffect", null);
EffectBase = __decorate([
    ccclass('EffectBase'),
    requireComponent(cc_4.Sprite),
    executeInEditMode(true)
], EffectBase);
exports.EffectBase = EffectBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWZmZWN0QmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9zY3JpcHQvRWZmZWN0QmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQkFBNEM7QUFDNUMsMkJBQStCO0FBQy9CLDJCQUEwQjtBQUMxQiwyQkFBNEI7QUFDNUIsMkJBQWlEO0FBQ2pELGdDQUE0RDtBQUU1RCxNQUFNLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxHQUFHLGVBQVUsQ0FBQztBQUs5RSxJQUFzQixVQUFVLEdBQWhDLE1BQXNCLFVBQVcsU0FBUSxjQUFTO0lBQWxEOztRQUVXLGdCQUFXLEdBQXVCLElBQUksQ0FBQztRQWNwQyxjQUFTLEdBQVksS0FBSyxDQUFDO1FBb0VyQyxZQUFZO1FBRUYsWUFBTyxHQUFrQixJQUFJLENBQUM7UUFDOUIsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUM1QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLFlBQU8sR0FBaUUsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNsRixtQkFBYyxHQUFZLEtBQUssQ0FBQztJQXNFNUMsQ0FBQztJQTVKRyxrQkFBa0I7SUFFbEIsSUFBVyxRQUFRO1FBQ2YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQzFCLENBQUM7SUFFRCxJQUFXLFFBQVEsQ0FBQyxHQUFZO1FBQzVCLElBQUksQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUlELFlBQVk7SUFHWixzQkFBc0I7SUFFdEIsSUFBWSxZQUFZO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBWSxZQUFZLENBQUMsR0FBWTtRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUNuQixJQUFJ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QUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQzswQ0FHdEY7QUFRRDtJQURDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUM7NkNBQ2pFO0FBTXJDO0lBREMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLGNBQVMsRUFBRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQzs4Q0FHOUQ7QUF4QmlCLFVBQVU7SUFIL0IsT0FBTyxDQUFDLFlBQVksQ0FBQztJQUNyQixnQkFBZ0IsQ0FBQyxXQUFNLENBQUM7SUFDeEIsaUJBQWlCLENBQUMsSUFBSSxDQUFDO0dBQ0YsVUFBVSxDQWdLL0I7QUFoS3FCLGdDQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWZmZWN0QXNzZXQsIGdhbWUsIGxvZyB9IGZyb20gJ2NjJztcbmltcG9ydCB7IENDQm9vbGVhbiB9IGZyb20gJ2NjJztcbmltcG9ydCB7IFZlYzQgfSBmcm9tICdjYyc7XG5pbXBvcnQgeyBTcHJpdGUgfSBmcm9tICdjYyc7XG5pbXBvcnQgeyBfZGVjb3JhdG9yLCBDb21wb25lbnQsIE5vZGUgfSBmcm9tICdjYyc7XG5pbXBvcnQgeyBERVYsIEVESVRPUiwgRURJVE9SX05PVF9JTl9QUkVWSUVXIH0gZnJvbSAnY2MvZW52JztcblxuY29uc3QgeyBjY2NsYXNzLCByZXF1aXJlQ29tcG9uZW50LCBleGVjdXRlSW5FZGl0TW9kZSwgcHJvcGVydHkgfSA9IF9kZWNvcmF0b3I7XG5cbkBjY2NsYXNzKCdFZmZlY3RCYXNlJylcbkByZXF1aXJlQ29tcG9uZW50KFNwcml0ZSlcbkBleGVjdXRlSW5FZGl0TW9kZSh0cnVlKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEVmZmVjdEJhc2UgZXh0ZW5kcyBDb21wb25lbnQge1xuICAgIEBwcm9wZXJ0eSh7IHR5cGU6IEVmZmVjdEFzc2V0LCB0b29sdGlwOiAn5oyH5a6a5pWI5p6cRWZmZWN0QXNzZXQnIH0pXG4gICAgcHVibGljIGVmZmVjdEFzc2V0OiBFZmZlY3RBc3NldCB8IG51bGwgPSBudWxsO1xuXG4gICAgLy8jcmVnaW9uIGlzMkRpbjNEXG4gICAgQHByb3BlcnR5KHsgZ3JvdXA6IHsgbmFtZTogXCJTZXR0ZXIvR2V0dGVyXCIsIGlkOiBcIjFcIiB9LCB0b29sdGlwOiAn55W25L2/55SoUmVuZGVyUm9vdDJE5pmC5L2/55SoJyB9KVxuICAgIHB1YmxpYyBnZXQgaXMyRGluM0QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pczJEaW4zRDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGlzMkRpbjNEKHZhbDogYm9vbGVhbikge1xuICAgICAgICB0aGlzLl9pczJEaW4zRCA9IHZhbDtcbiAgICAgICAgdGhpcy5faXMyRGluM0RDaGFuZ2VkKHRoaXMuX2lzMkRpbjNEKTtcbiAgICB9XG5cbiAgICBAcHJvcGVydHkoeyBncm91cDogeyBuYW1lOiBcIlByaXZhdGUgUHJvcHNcIiwgaWQ6IFwiMVwiIH0sIHZpc2libGU6IHRydWUsIHRvb2x0aXA6ICfnlbbkvb/nlKhSZW5kZXJSb290MkTmmYLkvb/nlKgnIH0pXG4gICAgcHJvdGVjdGVkIF9pczJEaW4zRDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIC8vI2VuZHJlZ2lvblxuXG5cbiAgICAvLyNyZWdpb24gcmVsb2FkRWZmZWN0XG4gICAgQHByb3BlcnR5KHsgdHlwZTogQ0NCb29sZWFuLCB0b29sdGlwOiAn5omL5YuV5Yi35paw77yM55W25pWI5p6c5ZyoRWRpdG9y5rKS5pyJ6aGv56S65pmCJyB9KVxuICAgIHByaXZhdGUgZ2V0IHJlbG9hZEVmZmVjdCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlbG9hZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldCByZWxvYWRFZmZlY3QodmFsOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuX3JlbG9hZCA9IHZhbDtcbiAgICAgICAgdGhpcy5yZWxvYWRUc0ZpbGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHJlbG9hZFRzRmlsZSgpIHtcbiAgICAgICAgaWYgKEVESVRPUl9OT1RfSU5fUFJFVklFVykge1xuICAgICAgICAgICAgY29uc3QgcmVsb2FkVHNGaWxlXzAwMCA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoXCJhc3NldC1kYlwiLCBcInJlaW1wb3J0LWFzc2V0XCIsIFwiODUzZThmYmYtOTc2OS00OWE4LWIyZDItMDAxNjM5MGI2OTUzXCIpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgYXV0b0Fzc2lnbkVmZmVjdEFzc2V0KCkge1xuICAgICAgICBpZiAoRURJVE9SX05PVF9JTl9QUkVWSUVXICYmIHRoaXMuZWZmZWN0QXNzZXQgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHV1aWRzID0gRWRpdG9yLlNlbGVjdGlvbi5nZXRTZWxlY3RlZCgnbm9kZScpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub2RlID0gYXdhaXQgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnc2NlbmUnLCAncXVlcnktbm9kZScsIHV1aWRzWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYOacqumBuOS4reevgOm7nmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0Q29tcE5hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gbm9kZS5fX2NvbXBzX18uZmluZEluZGV4KCh2OiBhbnkpID0+IHYudHlwZSA9PT0gZWZmZWN0Q29tcE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYOevgOm7nuacquaOm+i8iSR7ZWZmZWN0Q29tcE5hbWV957WE5Lu2YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlZmZlY3RGaWxlTmFtZSA9IGVmZmVjdENvbXBOYW1lLnJlcGxhY2UoLyhbQS1aXSkvZywgJ18kMScpLnRvTG93ZXJDYXNlKCkuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IGBkYjovL3Nwcml0ZV9lZmZlY3QvZWZmZWN0LyR7ZWZmZWN0RmlsZU5hbWV9LmVmZmVjdGA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2Fzc2V0LWRiJywgJ3F1ZXJ5LWFzc2V0LWluZm8nLCB1cmwpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHV1aWQgPSByZXMhLnV1aWQ7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdzY2VuZScsICdzZXQtcHJvcGVydHknLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1dWlkOiBub2RlLnV1aWQudmFsdWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogYF9fY29tcHNfXy4ke2luZGV4fS5lZmZlY3RBc3NldGAsXG4gICAgICAgICAgICAgICAgICAgICAgICBkdW1wOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2NjLkVmZmVjdEFzc2V0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEVmZmVjdOiHquWLleaOm+i8ieaIkOWKn2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yZWxvYWRUc0ZpbGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBFZmZlY3Toh6rli5XmjpvovInlpLHmlZdgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGF1dG9Bc3NpZ25FZmZlY3RBc3NldDogJHtleH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAxMDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vI2VuZHJlZ2lvblxuXG4gICAgcHJvdGVjdGVkIF9zcHJpdGU6IFNwcml0ZSB8IG51bGwgPSBudWxsO1xuICAgIHByb3RlY3RlZCBfaXNEaXJ0eTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgX3JlbG9hZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgX3BhcmFtczogTWFwPHN0cmluZywgeyBrZXk6IHN0cmluZywgaWR4OiBudW1iZXIsIGlzX2RpcnR5OiBib29sZWFuIH0+ID0gbmV3IE1hcCgpO1xuICAgIHByaXZhdGUgX2lzUGFyYW1zRGlydHk6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHByb3RlY3RlZCBvbkxvYWQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3Nwcml0ZSA9IHRoaXMuZ2V0Q29tcG9uZW50KFNwcml0ZSk7XG4gICAgICAgIHRoaXMuX2luc3RNYXRlcmlhbCgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzdGFydCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hdXRvQXNzaWduRWZmZWN0QXNzZXQoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdXBkYXRlKGR0OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX2lzUGFyYW1zRGlydHkpIHtcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5mb3JFYWNoKCh2YWwsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh2YWwuaXNfZGlydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlUGFyYW1zKHZhbC5rZXksIHZhbC5pZHgpO1xuICAgICAgICAgICAgICAgICAgICB2YWwuaXNfZGlydHkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuX2lzUGFyYW1zRGlydHkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEB2aXJ0dWFsXG4gICAgICogQGRlc2NyaXB0aW9uOiDlrp7kvovljJbmnZDotKhcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2luc3RNYXRlcmlhbCgpOiB2b2lkO1xuXG4gICAgLyoqXG4gICAgICogQHZpcnR1YWxcbiAgICAgKiBAZGVzY3JpcHRpb246IOabtOaWsOadkOi0qOWPguaVsFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBfdXBkYXRlUGFyYW1zKGtleTogc3RyaW5nLCBpZHg6IG51bWJlcik6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBAdmlydHVhbFxuICAgICAqIEBkZXNjcmlwdGlvbjog55W2U3ByaXRl6KKr55So5ZyoM0TmmYIo5o6b6LyJUmVuZGVyUm9vdDJE5pmCKe+8jOmcgOimgemWi+WVn+a3seW6pua4rOippuaJjeiDveato+eiuumhr+ekuua3seW6plxuICAgICAqL1xuICAgIHByb3RlY3RlZCBfaXMyRGluM0RDaGFuZ2VkKGVuYWJsZTogYm9vbGVhbikge1xuICAgICAgICB0aGlzLl9pbnN0TWF0ZXJpYWwoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX3NldFBhcmFtcyhrZXk6IHN0cmluZywgaWR4OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fcGFyYW1zLnNldChrZXksIHsga2V5OiBrZXksIGlkeDogaWR4LCBpc19kaXJ0eTogdHJ1ZSB9KTtcbiAgICAgICAgdGhpcy5faXNQYXJhbXNEaXJ0eSA9IHRydWU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9zZXRQYXJhbXNEaXJ0eShrZXk6IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5fcGFyYW1zLmhhcyhrZXkpKSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMuZ2V0KGtleSkhLmlzX2RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuX2lzUGFyYW1zRGlydHkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbG9nKGBFZmZlY3RCYXNlLl9zZXRQYXJhbXNEaXJ0eToga2V5ICR7a2V5fSBub3QgZm91bmRgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfZ2V0VVYodXY6IG51bWJlcltdKTogVmVjNCB7XG4gICAgICAgIGxldCBtaW5VID0gTWF0aC5taW4odXZbMF0sIHV2WzJdLCB1dls0XSwgdXZbNl0pO1xuICAgICAgICBsZXQgbWluViA9IE1hdGgubWluKHV2WzFdLCB1dlszXSwgdXZbNV0sIHV2WzddKTtcblxuICAgICAgICBsZXQgbWF4VSA9IE1hdGgubWF4KHV2WzBdLCB1dlsyXSwgdXZbNF0sIHV2WzZdKTtcbiAgICAgICAgbGV0IG1heFYgPSBNYXRoLm1heCh1dlsxXSwgdXZbM10sIHV2WzVdLCB1dls3XSk7XG5cbiAgICAgICAgbGV0IHdpZHRoID0gbWF4VSAtIG1pblU7XG4gICAgICAgIGxldCBoZWlnaHQgPSBtYXhWIC0gbWluVjtcblxuICAgICAgICByZXR1cm4gbmV3IFZlYzQobWluVSwgbWluViwgd2lkdGgsIGhlaWdodCk7XG4gICAgfVxufVxuXG5cbiJdfQ==