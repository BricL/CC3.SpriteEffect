"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var SpriteEffectBase_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpriteEffectBase = void 0;
const cc_1 = require("cc");
const env_1 = require("cc/env");
const { ccclass, property } = cc_1._decorator;
let SpriteEffectBase = SpriteEffectBase_1 = class SpriteEffectBase extends cc_1.Sprite {
    constructor() {
        super(...arguments);
        this.effectAsset = null;
        this._effectIndex = -1;
        this._effectColor = new cc_1.Color(255, 255, 255, 255);
        this._is2Din3D = false;
    }
    //#region effectColor
    set effectColor(val) {
        this._effectColor = val;
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            this.reflashParams();
        }
        else {
            this.reflashParams();
        }
    }
    get effectColor() {
        return this._effectColor;
    }
    //#endregion
    //#region is2Din3D
    set is2Din3D(val) {
        this._is2Din3D = val;
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            this.init(this.countOfProps);
            this.reflashParams();
        }
        else {
            this.reflashParams();
        }
    }
    get is2Din3D() {
        return this._is2Din3D;
    }
    //#endregion
    //#region methods
    get countOfProps() {
        const num = Math.ceil(this.countOfUsedFloats / 4.0);
        return num;
    }
    init(countOfProps) {
        const unionKey = this.getPropsUnionKey();
        cc_1.log(`init: ${unionKey}`);
        // Step1: 取的當前的effectIndex
        if (!SpriteEffectBase_1._s_effectMap.has(unionKey)) {
            const temp = new Array(768).fill(""); // R/G/B (0~255) => 256 * 3 = 768
            // temp[256] = temp[512] = "skip";
            SpriteEffectBase_1._s_effectMap.set(unionKey, temp);
        }
        let effectIndex = SpriteEffectBase_1._s_effectMap.get(unionKey).findIndex((v) => v === this.node.uuid);
        if (effectIndex === -1) {
            effectIndex = SpriteEffectBase_1._s_effectMap.get(unionKey).findIndex((v) => v === "");
            if (effectIndex === -1) {
                cc_1.error("Effect map is full!");
                return;
            }
        }
        this._effectIndex = effectIndex;
        SpriteEffectBase_1._s_effectMap.get(unionKey)[this._effectIndex] = this.node.uuid;
        if (this.propGroupIdx === 0) {
            this.color = new cc_1.Color(this._effectIndex, 0, 0, 255);
        }
        else if (this.propGroupIdx === 1) {
            this.color = new cc_1.Color(255, (this._effectIndex - 255), 0, 255);
        }
        else if (this.propGroupIdx === 2) {
            this.color = new cc_1.Color(255, 255, (this._effectIndex - 510), 255);
        }
        else {
            cc_1.error(`The prop group index, ${this.propGroupIdx}, is out of range!`);
            return;
        }
        // Step2: 初始化Effect props
        if (!SpriteEffectBase_1._s_effectProps.has(unionKey)) {
            const temp = new Array(3).fill(null); // Only use R/G/B 3 channels
            SpriteEffectBase_1._s_effectProps.set(unionKey, temp);
        }
        if (SpriteEffectBase_1._s_effectProps.get(unionKey)[this.propGroupIdx] === null) {
            const w = 256 * countOfProps;
            const h = 1;
            let propBuffer = new Float32Array(w * h * 4);
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const index = (y * w + x) * 4;
                    propBuffer[index] = 1;
                    propBuffer[index + 1] = 0;
                    propBuffer[index + 2] = 1;
                    propBuffer[index + 3] = 1;
                }
            }
            let propsTexture = new cc_1.Texture2D();
            propsTexture.setFilters(cc_1.Texture2D.Filter.NEAREST, cc_1.Texture2D.Filter.NEAREST);
            propsTexture.reset({
                width: w,
                height: h,
                format: cc_1.Texture2D.PixelFormat.RGBA32F,
                mipmapLevel: 0
            });
            propsTexture.uploadData(propBuffer);
            let mat = this.initMaterial();
            mat.setProperty('propsTexture', propsTexture);
            SpriteEffectBase_1._s_effectProps.get(unionKey)[this.propGroupIdx] = {
                mat: mat,
                propBuffer: propBuffer,
                propTexture: propsTexture
            };
        }
        this.customMaterial = SpriteEffectBase_1._s_effectProps.get(unionKey)[this.propGroupIdx].mat;
    }
    reflashParams() {
        const index = this.getBufferIndex();
        const effectProps = SpriteEffectBase_1._s_effectProps.get(this.getPropsUnionKey())[this.propGroupIdx];
        this.updateParams(index, effectProps.propBuffer);
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            effectProps.propTexture.uploadData(effectProps.propBuffer);
        }
        else {
            this.setDirty(this.propGroupIdx, true);
        }
    }
    get propGroupIdx() {
        return Math.floor(this._effectIndex / 256);
    }
    getUV(uv) {
        let minU = Math.min(uv[0], uv[2], uv[4], uv[6]);
        let minV = Math.min(uv[1], uv[3], uv[5], uv[7]);
        let maxU = Math.max(uv[0], uv[2], uv[4], uv[6]);
        let maxV = Math.max(uv[1], uv[3], uv[5], uv[7]);
        let width = maxU - minU;
        let height = maxV - minV;
        return new cc_1.Vec4(minU, minV, width, height);
    }
    getBufferIndex() {
        let effectIndex = this._effectIndex - (this.propGroupIdx * 256);
        const index = (effectIndex * this.countOfProps) * 4;
        return index;
    }
    //#endregion
    //#region life cycle
    onLoad() {
        this.init(this.countOfProps);
    }
    start() {
        this.reflashParams();
    }
    onDestroy() {
        const unionKey = this.getPropsUnionKey();
        if (SpriteEffectBase_1._s_effectMap.has(unionKey)) {
            const index = SpriteEffectBase_1._s_effectMap.get(unionKey).findIndex((v) => v === this.node.uuid);
            if (index === -1) {
                cc_1.error("Effect index is not found!");
                return;
            }
            SpriteEffectBase_1._s_effectMap.get(unionKey)[index] = "";
        }
        else {
            cc_1.error(`The effect map of ${unionKey} is not found!`);
        }
    }
    lateUpdate(dt) {
        if (this.isDirty(this.propGroupIdx)) {
            cc_1.log(`${this.constructor.name}'s effect props is DIRTY!`);
            const unionKey = this.getPropsUnionKey();
            const effectProps = SpriteEffectBase_1._s_effectProps.get(unionKey)[this.propGroupIdx];
            effectProps.propTexture.uploadData(effectProps.propBuffer);
            this.setDirty(this.propGroupIdx, false);
        }
    }
};
SpriteEffectBase._s_effectMap = new Map();
SpriteEffectBase._s_effectProps = new Map();
__decorate([
    property({ type: cc_1.EffectAsset, tooltip: '指定效果EffectAsset' })
], SpriteEffectBase.prototype, "effectAsset", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, type: cc_1.Color, tooltip: "My Color" })
], SpriteEffectBase.prototype, "effectColor", null);
__decorate([
    property
], SpriteEffectBase.prototype, "_effectColor", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, tooltip: '當使用RenderRoot2D時使用' })
], SpriteEffectBase.prototype, "is2Din3D", null);
__decorate([
    property
], SpriteEffectBase.prototype, "_is2Din3D", void 0);
SpriteEffectBase = SpriteEffectBase_1 = __decorate([
    ccclass('SpriteEffectBase')
], SpriteEffectBase);
exports.SpriteEffectBase = SpriteEffectBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3ByaXRlRWZmZWN0QmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS9hc3NldHMvY29tcC9TcHJpdGVFZmZlY3RCYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwyQkFBbUc7QUFDbkcsZ0NBQStDO0FBQy9DLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsZUFBVSxDQUFDO0FBU3pDLElBQXNCLGdCQUFnQix3QkFBdEMsTUFBc0IsZ0JBQWlCLFNBQVEsV0FBTTtJQUFyRDs7UUFLVyxnQkFBVyxHQUF1QixJQUFJLENBQUM7UUFFcEMsaUJBQVksR0FBVyxDQUFDLENBQUMsQ0FBQztRQW9CMUIsaUJBQVksR0FBVSxJQUFJLFVBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQXVCcEQsY0FBUyxHQUFZLEtBQUssQ0FBQztJQWdNekMsQ0FBQztJQXpPRyxxQkFBcUI7SUFFckIsSUFBVyxXQUFXLENBQUMsR0FBVTtRQUM3QixJQUFJLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztRQUV4QixJQUFJLDJCQUFxQixFQUFFO1lBQ3ZCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN4QjthQUNJO1lBQ0QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3hCO0lBQ0wsQ0FBQztJQUVELElBQVcsV0FBVztRQUNsQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDN0IsQ0FBQztJQUlELFlBQVk7SUFHWixrQkFBa0I7SUFFbEIsSUFBVyxRQUFRLENBQUMsR0FBWTtRQUM1QixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUVyQixJQUFJLDJCQUFxQixFQUFFO1lBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN4Qjth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QUNOLGdCQUFnQixDQWtQckM7QUFsUHFCLDRDQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IF9kZWNvcmF0b3IsIENvbG9yLCBFZmZlY3RBc3NldCwgZXJyb3IsIGxvZywgTWF0ZXJpYWwsIFNwcml0ZSwgVGV4dHVyZTJELCBWZWM0IH0gZnJvbSBcImNjXCI7XG5pbXBvcnQgeyBFRElUT1JfTk9UX0lOX1BSRVZJRVcgfSBmcm9tIFwiY2MvZW52XCI7XG5jb25zdCB7IGNjY2xhc3MsIHByb3BlcnR5IH0gPSBfZGVjb3JhdG9yO1xuXG5leHBvcnQgdHlwZSBFZmZlY3RQcm9wcyA9IHtcbiAgICBtYXQ6IE1hdGVyaWFsIHwgbnVsbDtcbiAgICBwcm9wQnVmZmVyOiBGbG9hdDMyQXJyYXkgfCBudWxsO1xuICAgIHByb3BUZXh0dXJlOiBUZXh0dXJlMkQgfCBudWxsO1xufVxuXG5AY2NjbGFzcygnU3ByaXRlRWZmZWN0QmFzZScpXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3ByaXRlRWZmZWN0QmFzZSBleHRlbmRzIFNwcml0ZSB7XG4gICAgcHJvdGVjdGVkIHN0YXRpYyBfc19lZmZlY3RNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nW10+KCk7XG4gICAgcHJvdGVjdGVkIHN0YXRpYyBfc19lZmZlY3RQcm9wcyA9IG5ldyBNYXA8c3RyaW5nLCBFZmZlY3RQcm9wc1tdPigpO1xuXG4gICAgQHByb3BlcnR5KHsgdHlwZTogRWZmZWN0QXNzZXQsIHRvb2x0aXA6ICfmjIflrprmlYjmnpxFZmZlY3RBc3NldCcgfSlcbiAgICBwdWJsaWMgZWZmZWN0QXNzZXQ6IEVmZmVjdEFzc2V0IHwgbnVsbCA9IG51bGw7XG5cbiAgICBwcm90ZWN0ZWQgX2VmZmVjdEluZGV4OiBudW1iZXIgPSAtMTtcblxuICAgIC8vI3JlZ2lvbiBlZmZlY3RDb2xvclxuICAgIEBwcm9wZXJ0eSh7IGdyb3VwOiB7IG5hbWU6IFwiU2V0dGVyL0dldHRlclwiLCBpZDogXCIxXCIgfSwgdHlwZTogQ29sb3IsIHRvb2x0aXA6IFwiTXkgQ29sb3JcIiB9KVxuICAgIHB1YmxpYyBzZXQgZWZmZWN0Q29sb3IodmFsOiBDb2xvcikge1xuICAgICAgICB0aGlzLl9lZmZlY3RDb2xvciA9IHZhbDtcblxuICAgICAgICBpZiAoRURJVE9SX05PVF9JTl9QUkVWSUVXKSB7XG4gICAgICAgICAgICB0aGlzLnJlZmxhc2hQYXJhbXMoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVmbGFzaFBhcmFtcygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBlZmZlY3RDb2xvcigpOiBDb2xvciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lZmZlY3RDb2xvcjtcbiAgICB9XG5cbiAgICBAcHJvcGVydHlcbiAgICBwcm90ZWN0ZWQgX2VmZmVjdENvbG9yOiBDb2xvciA9IG5ldyBDb2xvcigyNTUsIDI1NSwgMjU1LCAyNTUpO1xuICAgIC8vI2VuZHJlZ2lvblxuXG5cbiAgICAvLyNyZWdpb24gaXMyRGluM0RcbiAgICBAcHJvcGVydHkoeyBncm91cDogeyBuYW1lOiBcIlNldHRlci9HZXR0ZXJcIiwgaWQ6IFwiMVwiIH0sIHRvb2x0aXA6ICfnlbbkvb/nlKhSZW5kZXJSb290MkTmmYLkvb/nlKgnIH0pXG4gICAgcHVibGljIHNldCBpczJEaW4zRCh2YWw6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5faXMyRGluM0QgPSB2YWw7XG5cbiAgICAgICAgaWYgKEVESVRPUl9OT1RfSU5fUFJFVklFVykge1xuICAgICAgICAgICAgdGhpcy5pbml0KHRoaXMuY291bnRPZlByb3BzKTtcbiAgICAgICAgICAgIHRoaXMucmVmbGFzaFBhcmFtcygpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWZsYXNoUGFyYW1zKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzMkRpbjNEKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXMyRGluM0Q7XG4gICAgfVxuXG4gICAgQHByb3BlcnR5XG4gICAgcHJvdGVjdGVkIF9pczJEaW4zRDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIC8vI2VuZHJlZ2lvblxuXG5cbiAgICAvLyNyZWdpb24gYWJzdHJhY3QgbWV0aG9kc1xuICAgIC8qKlxuICAgICAqIEBhYnN0cmFjdFxuICAgICAqIFJldHVybiB0aGUgY291bnQgb2YgdXNlZCBmbG9hdHMgb2YgdGhlIGVmZmVjdC5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IGNvdW50T2ZVc2VkRmxvYXRzKCk6IG51bWJlcjtcblxuICAgIC8qKlxuICAgICAqIEBhYnN0cmFjdCBcbiAgICAgKiBHZW5lcmF0ZSBhIFVuaW9uIGtleSBmb3IgdGhlIGVmZmVjdC5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0UHJvcHNVbmlvbktleSgpOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBAYWJzdHJhY3RcbiAgICAgKiBVcGRhdGUgdGhlIGVmZmVjdCBwYXJhbWV0ZXJzLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCB1cGRhdGVQYXJhbXMoaW5kZXg6IG51bWJlciwgcHJvcEJ1ZmZlcjogRmxvYXQzMkFycmF5KTogdm9pZDtcblxuICAgIC8qKlxuICAgICAqIEBhYnN0cmFjdFxuICAgICAqIEluaXRpYWxpemUgdGhlIG1hdGVyaWFsLlxuICAgICAqIEByZXR1cm5zIE1hdGVyaWFsXG4gICAgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgaW5pdE1hdGVyaWFsKCk6IE1hdGVyaWFsO1xuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGlzRGlydHkoaWR4OiBudW1iZXIpOiBib29sZWFuO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBzZXREaXJ0eShpZHg6IG51bWJlciwgdmFsOiBib29sZWFuKTogdm9pZDtcbiAgICAvLyNlbmRyZWdpb25cblxuXG4gICAgLy8jcmVnaW9uIG1ldGhvZHNcbiAgICBwcm90ZWN0ZWQgZ2V0IGNvdW50T2ZQcm9wcygpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBudW0gPSBNYXRoLmNlaWwodGhpcy5jb3VudE9mVXNlZEZsb2F0cyAvIDQuMCk7XG4gICAgICAgIHJldHVybiBudW07XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGluaXQoY291bnRPZlByb3BzOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgdW5pb25LZXkgPSB0aGlzLmdldFByb3BzVW5pb25LZXkoKTtcbiAgICAgICAgbG9nKGBpbml0OiAke3VuaW9uS2V5fWApO1xuXG4gICAgICAgIC8vIFN0ZXAxOiDlj5bnmoTnlbbliY3nmoRlZmZlY3RJbmRleFxuICAgICAgICBpZiAoIVNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0TWFwLmhhcyh1bmlvbktleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlbXAgPSBuZXcgQXJyYXkoNzY4KS5maWxsKFwiXCIpOyAgLy8gUi9HL0IgKDB+MjU1KSA9PiAyNTYgKiAzID0gNzY4XG4gICAgICAgICAgICAvLyB0ZW1wWzI1Nl0gPSB0ZW1wWzUxMl0gPSBcInNraXBcIjtcbiAgICAgICAgICAgIFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0TWFwLnNldCh1bmlvbktleSwgdGVtcCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZWZmZWN0SW5kZXggPSBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdE1hcC5nZXQodW5pb25LZXkpIS5maW5kSW5kZXgoKHYpID0+IHYgPT09IHRoaXMubm9kZS51dWlkKTtcbiAgICAgICAgaWYgKGVmZmVjdEluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgZWZmZWN0SW5kZXggPSBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdE1hcC5nZXQodW5pb25LZXkpIS5maW5kSW5kZXgoKHYpID0+IHYgPT09IFwiXCIpO1xuICAgICAgICAgICAgaWYgKGVmZmVjdEluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgIGVycm9yKFwiRWZmZWN0IG1hcCBpcyBmdWxsIVwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fZWZmZWN0SW5kZXggPSBlZmZlY3RJbmRleDtcblxuICAgICAgICBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdE1hcC5nZXQodW5pb25LZXkpIVt0aGlzLl9lZmZlY3RJbmRleF0gPSB0aGlzLm5vZGUudXVpZDtcblxuICAgICAgICBpZiAodGhpcy5wcm9wR3JvdXBJZHggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBuZXcgQ29sb3IodGhpcy5fZWZmZWN0SW5kZXgsIDAsIDAsIDI1NSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcm9wR3JvdXBJZHggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuY29sb3IgPSBuZXcgQ29sb3IoMjU1LCAodGhpcy5fZWZmZWN0SW5kZXggLSAyNTUpLCAwLCAyNTUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucHJvcEdyb3VwSWR4ID09PSAyKSB7XG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gbmV3IENvbG9yKDI1NSwgMjU1LCAodGhpcy5fZWZmZWN0SW5kZXggLSA1MTApLCAyNTUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZXJyb3IoYFRoZSBwcm9wIGdyb3VwIGluZGV4LCAke3RoaXMucHJvcEdyb3VwSWR4fSwgaXMgb3V0IG9mIHJhbmdlIWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3RlcDI6IOWIneWni+WMlkVmZmVjdCBwcm9wc1xuICAgICAgICBpZiAoIVNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0UHJvcHMuaGFzKHVuaW9uS2V5KSkge1xuICAgICAgICAgICAgY29uc3QgdGVtcCA9IG5ldyBBcnJheSgzKS5maWxsKG51bGwpOyAvLyBPbmx5IHVzZSBSL0cvQiAzIGNoYW5uZWxzXG4gICAgICAgICAgICBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdFByb3BzLnNldCh1bmlvbktleSwgdGVtcCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RQcm9wcy5nZXQodW5pb25LZXkpIVt0aGlzLnByb3BHcm91cElkeF0gPT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHcgPSAyNTYgKiBjb3VudE9mUHJvcHM7XG4gICAgICAgICAgICBjb25zdCBoID0gMTtcblxuICAgICAgICAgICAgbGV0IHByb3BCdWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KHcgKiBoICogNCk7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGg7IHkrKykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdzsgeCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gKHkgKiB3ICsgeCkgKiA0O1xuICAgICAgICAgICAgICAgICAgICBwcm9wQnVmZmVyW2luZGV4XSA9IDE7XG4gICAgICAgICAgICAgICAgICAgIHByb3BCdWZmZXJbaW5kZXggKyAxXSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIHByb3BCdWZmZXJbaW5kZXggKyAyXSA9IDE7XG4gICAgICAgICAgICAgICAgICAgIHByb3BCdWZmZXJbaW5kZXggKyAzXSA9IDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcHJvcHNUZXh0dXJlID0gbmV3IFRleHR1cmUyRCgpO1xuICAgICAgICAgICAgcHJvcHNUZXh0dXJlLnNldEZpbHRlcnMoVGV4dHVyZTJELkZpbHRlci5ORUFSRVNULCBUZXh0dXJlMkQuRmlsdGVyLk5FQVJFU1QpO1xuICAgICAgICAgICAgcHJvcHNUZXh0dXJlLnJlc2V0KHtcbiAgICAgICAgICAgICAgICB3aWR0aDogdyxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IGgsXG4gICAgICAgICAgICAgICAgZm9ybWF0OiBUZXh0dXJlMkQuUGl4ZWxGb3JtYXQuUkdCQTMyRixcbiAgICAgICAgICAgICAgICBtaXBtYXBMZXZlbDogMFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwcm9wc1RleHR1cmUudXBsb2FkRGF0YShwcm9wQnVmZmVyKTtcblxuICAgICAgICAgICAgbGV0IG1hdCA9IHRoaXMuaW5pdE1hdGVyaWFsKCk7XG4gICAgICAgICAgICBtYXQuc2V0UHJvcGVydHkoJ3Byb3BzVGV4dHVyZScsIHByb3BzVGV4dHVyZSk7XG5cbiAgICAgICAgICAgIFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0UHJvcHMuZ2V0KHVuaW9uS2V5KSFbdGhpcy5wcm9wR3JvdXBJZHhdID0ge1xuICAgICAgICAgICAgICAgIG1hdDogbWF0LFxuICAgICAgICAgICAgICAgIHByb3BCdWZmZXI6IHByb3BCdWZmZXIsXG4gICAgICAgICAgICAgICAgcHJvcFRleHR1cmU6IHByb3BzVGV4dHVyZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3VzdG9tTWF0ZXJpYWwgPSBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdFByb3BzLmdldCh1bmlvbktleSkhW3RoaXMucHJvcEdyb3VwSWR4XS5tYXQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlZmxhc2hQYXJhbXMoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5nZXRCdWZmZXJJbmRleCgpO1xuICAgICAgICBjb25zdCBlZmZlY3RQcm9wcyA9IFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0UHJvcHMuZ2V0KHRoaXMuZ2V0UHJvcHNVbmlvbktleSgpKSFbdGhpcy5wcm9wR3JvdXBJZHhdO1xuICAgICAgICB0aGlzLnVwZGF0ZVBhcmFtcyhpbmRleCwgZWZmZWN0UHJvcHMucHJvcEJ1ZmZlciEpO1xuXG4gICAgICAgIGlmIChFRElUT1JfTk9UX0lOX1BSRVZJRVcpIHtcbiAgICAgICAgICAgIGVmZmVjdFByb3BzLnByb3BUZXh0dXJlIS51cGxvYWREYXRhKGVmZmVjdFByb3BzLnByb3BCdWZmZXIhKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGlydHkodGhpcy5wcm9wR3JvdXBJZHgsIHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBwcm9wR3JvdXBJZHgoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy5fZWZmZWN0SW5kZXggLyAyNTYpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRVVih1djogbnVtYmVyW10pOiBWZWM0IHtcbiAgICAgICAgbGV0IG1pblUgPSBNYXRoLm1pbih1dlswXSwgdXZbMl0sIHV2WzRdLCB1dls2XSk7XG4gICAgICAgIGxldCBtaW5WID0gTWF0aC5taW4odXZbMV0sIHV2WzNdLCB1dls1XSwgdXZbN10pO1xuXG4gICAgICAgIGxldCBtYXhVID0gTWF0aC5tYXgodXZbMF0sIHV2WzJdLCB1dls0XSwgdXZbNl0pO1xuICAgICAgICBsZXQgbWF4ViA9IE1hdGgubWF4KHV2WzFdLCB1dlszXSwgdXZbNV0sIHV2WzddKTtcblxuICAgICAgICBsZXQgd2lkdGggPSBtYXhVIC0gbWluVTtcbiAgICAgICAgbGV0IGhlaWdodCA9IG1heFYgLSBtaW5WO1xuXG4gICAgICAgIHJldHVybiBuZXcgVmVjNChtaW5VLCBtaW5WLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0QnVmZmVySW5kZXgoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGVmZmVjdEluZGV4ID0gdGhpcy5fZWZmZWN0SW5kZXggLSAodGhpcy5wcm9wR3JvdXBJZHggKiAyNTYpO1xuICAgICAgICBjb25zdCBpbmRleCA9IChlZmZlY3RJbmRleCAqIHRoaXMuY291bnRPZlByb3BzKSAqIDQ7XG4gICAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG4gICAgLy8jZW5kcmVnaW9uXG5cblxuICAgIC8vI3JlZ2lvbiBsaWZlIGN5Y2xlXG4gICAgb25Mb2FkKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmluaXQodGhpcy5jb3VudE9mUHJvcHMpO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLnJlZmxhc2hQYXJhbXMoKTtcbiAgICB9XG5cbiAgICBvbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHVuaW9uS2V5ID0gdGhpcy5nZXRQcm9wc1VuaW9uS2V5KCk7XG5cbiAgICAgICAgaWYgKFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0TWFwLmhhcyh1bmlvbktleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RNYXAuZ2V0KHVuaW9uS2V5KSEuZmluZEluZGV4KCh2KSA9PiB2ID09PSB0aGlzLm5vZGUudXVpZCk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgZXJyb3IoXCJFZmZlY3QgaW5kZXggaXMgbm90IGZvdW5kIVwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0TWFwLmdldCh1bmlvbktleSkhW2luZGV4XSA9IFwiXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlcnJvcihgVGhlIGVmZmVjdCBtYXAgb2YgJHt1bmlvbktleX0gaXMgbm90IGZvdW5kIWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGF0ZVVwZGF0ZShkdDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzRGlydHkodGhpcy5wcm9wR3JvdXBJZHgpKSB7XG4gICAgICAgICAgICBsb2coYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSdzIGVmZmVjdCBwcm9wcyBpcyBESVJUWSFgKTtcbiAgICAgICAgICAgIGNvbnN0IHVuaW9uS2V5ID0gdGhpcy5nZXRQcm9wc1VuaW9uS2V5KCk7XG4gICAgICAgICAgICBjb25zdCBlZmZlY3RQcm9wcyA9IFNwcml0ZUVmZmVjdEJhc2UuX3NfZWZmZWN0UHJvcHMuZ2V0KHVuaW9uS2V5KSFbdGhpcy5wcm9wR3JvdXBJZHhdO1xuXG4gICAgICAgICAgICBlZmZlY3RQcm9wcy5wcm9wVGV4dHVyZSEudXBsb2FkRGF0YShlZmZlY3RQcm9wcy5wcm9wQnVmZmVyISk7XG4gICAgICAgICAgICB0aGlzLnNldERpcnR5KHRoaXMucHJvcEdyb3VwSWR4LCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG59Il19