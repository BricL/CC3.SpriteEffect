"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var SpriteEffectBase_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpriteEffectBase = void 0;
const cc_1 = require("cc");
const env_1 = require("cc/env");
const { ccclass, property } = cc_1._decorator;
const PROP_TEXTURE_SIZE = 128;
let SpriteEffectBase = SpriteEffectBase_1 = class SpriteEffectBase extends cc_1.Sprite {
    constructor() {
        super(...arguments);
        this.effectAsset = null;
        this._instanceID = -1;
        this._effectColor = new cc_1.Color(255, 255, 255, 255);
        this._is2Din3D = false;
        this._sampleFromRT = false;
    }
    //#region effectColor
    set effectColor(val) {
        this._effectColor = val;
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            this.reflashParams();
        }
        else {
            this.reflashParams();
        }
    }
    get effectColor() {
        return this._effectColor;
    }
    //#endregion
    //#region is2Din3D
    set is2Din3D(val) {
        this._is2Din3D = val;
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            this.init(this.pixelsUsage);
            this.reflashParams();
        }
        else {
            this.reflashParams();
        }
    }
    get is2Din3D() {
        return this._is2Din3D;
    }
    //#endregion
    //#region sampleFromRT
    set sampleFromRT(val) {
        this._sampleFromRT = val;
        this.resetMaterial({
            defines: {
                SAMPLE_FROM_RT: this._sampleFromRT,
            }
        });
    }
    get sampleFromRT() {
        return this._sampleFromRT;
    }
    /**
     * @abstract
     * Reset the material.
     * @returns void
     */
    resetMaterial(matInfo) {
        if (this.customMaterial) {
            this.customMaterial.copy(this.customMaterial, matInfo);
        }
    }
    //#endregion
    //#region methods
    /**
     * 4個float為一個pixel，需使用幾個pixel數量
     */
    get pixelsUsage() {
        return Math.pow(2, Math.ceil(Math.log(this.floatUsage) / Math.log(2))) / 4;
    }
    calBufferIndex(x, y, w) {
        return (x + (y * w)) * 4;
    }
    init(pixelsUsage) {
        const unionKey = this.getEffectUnionKey();
        // Step1: 取的當前的effectIndex
        if (!SpriteEffectBase_1._s_effectMap.has(unionKey)) {
            cc_1.log(`init: ${unionKey} not found, create new one`);
            let effectData = {
                data: [],
                uuids: []
            };
            effectData.data.push({
                mat: null,
                propBuffer: null,
                propTexture: null,
                isDirty: false,
            });
            SpriteEffectBase_1._s_effectMap.set(unionKey, effectData);
        }
        const effectData = SpriteEffectBase_1._s_effectMap.get(unionKey);
        this._instanceID = effectData.uuids.findIndex((v) => v === this.node.uuid);
        if (this._instanceID === -1) {
            this._instanceID = effectData.uuids.findIndex((v) => v === "");
            if (this._instanceID === -1) {
                this._instanceID = effectData.uuids.push(this.node.uuid) - 1;
                if (effectData.data.length < Math.floor(this._instanceID / PROP_TEXTURE_SIZE) + 1) {
                    effectData.data.push({
                        mat: null,
                        propBuffer: null,
                        propTexture: null,
                        isDirty: false,
                    });
                }
            }
            else {
                effectData.uuids[this._instanceID] = this.node.uuid;
            }
        }
        const idx = Math.floor(this._instanceID / PROP_TEXTURE_SIZE);
        this.color = new cc_1.Color(this._instanceID % PROP_TEXTURE_SIZE, pixelsUsage, PROP_TEXTURE_SIZE, 255);
        // Step2: 初始化Effect props
        if (effectData.data[idx].mat === null) {
            const w = PROP_TEXTURE_SIZE;
            const h = pixelsUsage;
            let propBuffer = new Float32Array(w * h * 4);
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const index = (x + (y * w)) * 4;
                    propBuffer[index] = 1;
                    propBuffer[index + 1] = 0;
                    propBuffer[index + 2] = 1;
                    propBuffer[index + 3] = 1;
                }
            }
            let propsTexture = new cc_1.Texture2D();
            propsTexture.setFilters(cc_1.Texture2D.Filter.NEAREST, cc_1.Texture2D.Filter.NEAREST);
            propsTexture.reset({
                width: w,
                height: h,
                format: cc_1.Texture2D.PixelFormat.RGBA32F,
                mipmapLevel: 0
            });
            propsTexture.uploadData(propBuffer);
            let mat = this.initMaterial();
            mat.setProperty('propsTexture', propsTexture);
            effectData.data[idx] = {
                mat: mat,
                propBuffer: propBuffer,
                propTexture: propsTexture,
                isDirty: false
            };
        }
        this.customMaterial = effectData.data[idx].mat;
    }
    reflashParams() {
        const unionKey = this.getEffectUnionKey();
        const idx = Math.floor(this._instanceID / PROP_TEXTURE_SIZE);
        const effectProps = SpriteEffectBase_1._s_effectMap.get(unionKey).data[idx];
        // Update the effect parameters from the DERIVED class.
        this.updateParams(this._instanceID % PROP_TEXTURE_SIZE, PROP_TEXTURE_SIZE - 1, effectProps.propBuffer);
        if (env_1.EDITOR_NOT_IN_PREVIEW) {
            // In Editor mode, upload the data directly.
            effectProps.propTexture.uploadData(effectProps.propBuffer);
        }
        else {
            // In Preview mode, wait for the lateUpdate to upload the data.
            effectProps.isDirty = true;
        }
    }
    /**
     * 取得 Sprite 的 UV 最小、最大值及寬高
     * @param uv
     * @returns vec4 (minU, minV, width, height)
     */
    getUV(uv) {
        let minU = Math.min(uv[0], uv[2], uv[4], uv[6]);
        let minV = Math.min(uv[1], uv[3], uv[5], uv[7]);
        let maxU = Math.max(uv[0], uv[2], uv[4], uv[6]);
        let maxV = Math.max(uv[1], uv[3], uv[5], uv[7]);
        let width = maxU - minU;
        let height = maxV - minV;
        return new cc_1.Vec4(minU, minV, width, height);
    }
    //#endregion
    //#region life cycle
    onLoad() {
        super.onLoad();
        this.init(this.pixelsUsage);
    }
    start() {
        this.reflashParams();
    }
    onDestroy() {
        const unionKey = this.getEffectUnionKey();
        const effectData = SpriteEffectBase_1._s_effectMap.get(unionKey);
        const idx = effectData.uuids.findIndex((v) => v === this.node.uuid);
        if (idx === -1) {
            cc_1.error("Effect index is not found!");
        }
        else {
            this._instanceID = -1;
            effectData.uuids[idx] = "";
        }
    }
    lateUpdate(dt) {
        const unionKey = this.getEffectUnionKey();
        const effectData = SpriteEffectBase_1._s_effectMap.get(unionKey);
        const idx = Math.floor(this._instanceID / PROP_TEXTURE_SIZE);
        const effectProps = effectData.data[idx];
        if (effectProps.isDirty) {
            effectProps.propTexture.uploadData(effectProps.propBuffer);
            effectProps.isDirty = false;
        }
    }
};
SpriteEffectBase._s_effectMap = new Map();
__decorate([
    property({ type: cc_1.EffectAsset, tooltip: '指定效果EffectAsset' })
], SpriteEffectBase.prototype, "effectAsset", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, type: cc_1.Color, tooltip: "My Color" })
], SpriteEffectBase.prototype, "effectColor", null);
__decorate([
    property
], SpriteEffectBase.prototype, "_effectColor", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, tooltip: '當使用RenderRoot2D時使用' })
], SpriteEffectBase.prototype, "is2Din3D", null);
__decorate([
    property
], SpriteEffectBase.prototype, "_is2Din3D", void 0);
__decorate([
    property({ group: { name: "Setter/Getter", id: "1" }, tooltip: '當Sprite來源RenderTexture時使用' })
], SpriteEffectBase.prototype, "sampleFromRT", null);
__decorate([
    property
], SpriteEffectBase.prototype, "_sampleFromRT", void 0);
SpriteEffectBase = SpriteEffectBase_1 = __decorate([
    ccclass('SpriteEffectBase')
], SpriteEffectBase);
exports.SpriteEffectBase = SpriteEffectBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3ByaXRlRWZmZWN0QmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS9zdGF0aWMvY29tcC9TcHJpdGVFZmZlY3RCYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwyQkFBa0g7QUFDbEgsZ0NBQStDO0FBQy9DLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsZUFBVSxDQUFDO0FBY3pDLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxDQUFDO0FBRzlCLElBQXNCLGdCQUFnQix3QkFBdEMsTUFBc0IsZ0JBQWlCLFNBQVEsV0FBTTtJQUFyRDs7UUFJVyxnQkFBVyxHQUF1QixJQUFJLENBQUM7UUFFcEMsZ0JBQVcsR0FBVyxDQUFDLENBQUMsQ0FBQztRQW9CekIsaUJBQVksR0FBVSxJQUFJLFVBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQXVCcEQsY0FBUyxHQUFZLEtBQUssQ0FBQztRQW1CM0Isa0JBQWEsR0FBWSxLQUFLLENBQUM7SUF1TjdDLENBQUM7SUFuUkcscUJBQXFCO0lBRXJCLElBQVcsV0FBVyxDQUFDLEdBQVU7UUFDN0IsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUM7UUFFeEIsSUFBSSwyQkFBcUIsRUFBRTtZQUN2QixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDeEI7YUFDSTtZQUNELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN4QjtJQUNMLENBQUM7SUFFRCxJQUFXLFdBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzdCLENBQUM7SUFJRCxZQUFZO0lBR1osa0JBQWtCO0lBRWxCLElBQVcsUUFBUSxDQUFDLEdBQVk7UUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7UUFFckIsSUFBSSwyQkFBcUIsRUFBRTtZQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDLElB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LFFBQVE7c0RBQ3FEO0FBTTlEO0lBREMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUM7Z0RBV3RGO0FBT0Q7SUFEQyxRQUFRO21EQUM0QjtBQUtyQztJQURDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxDQUFDO29EQVE3RjtBQU9EO0lBREMsUUFBUTt1REFDZ0M7QUFwRXZCLGdCQUFnQjtJQURyQyxPQUFPLENBQUMsa0JBQWtCLENBQUM7R0FDTixnQkFBZ0IsQ0EyUnJDO0FBM1JxQiw0Q0FBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfZGVjb3JhdG9yLCBDb2xvciwgRWZmZWN0QXNzZXQsIGVycm9yLCBJTWF0ZXJpYWxJbmZvLCBsb2csIE1hdGVyaWFsLCBTcHJpdGUsIFRleHR1cmUyRCwgVmVjNCB9IGZyb20gXCJjY1wiO1xyXG5pbXBvcnQgeyBFRElUT1JfTk9UX0lOX1BSRVZJRVcgfSBmcm9tIFwiY2MvZW52XCI7XHJcbmNvbnN0IHsgY2NjbGFzcywgcHJvcGVydHkgfSA9IF9kZWNvcmF0b3I7XHJcblxyXG50eXBlIEVmZmVjdFByb3BzID0ge1xyXG4gICAgbWF0OiBNYXRlcmlhbCB8IG51bGw7XHJcbiAgICBwcm9wQnVmZmVyOiBGbG9hdDMyQXJyYXkgfCBudWxsO1xyXG4gICAgcHJvcFRleHR1cmU6IFRleHR1cmUyRCB8IG51bGw7XHJcbiAgICBpc0RpcnR5OiBib29sZWFuO1xyXG59XHJcblxyXG50eXBlIEVmZmVjdERhdGEgPSB7XHJcbiAgICBkYXRhOiBFZmZlY3RQcm9wc1tdO1xyXG4gICAgdXVpZHM6IHN0cmluZ1tdO1xyXG59XHJcblxyXG5jb25zdCBQUk9QX1RFWFRVUkVfU0laRSA9IDEyODtcclxuXHJcbkBjY2NsYXNzKCdTcHJpdGVFZmZlY3RCYXNlJylcclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNwcml0ZUVmZmVjdEJhc2UgZXh0ZW5kcyBTcHJpdGUge1xyXG4gICAgcHJvdGVjdGVkIHN0YXRpYyBfc19lZmZlY3RNYXAgPSBuZXcgTWFwPHN0cmluZywgRWZmZWN0RGF0YT4oKTtcclxuXHJcbiAgICBAcHJvcGVydHkoeyB0eXBlOiBFZmZlY3RBc3NldCwgdG9vbHRpcDogJ+aMh+WumuaViOaenEVmZmVjdEFzc2V0JyB9KVxyXG4gICAgcHVibGljIGVmZmVjdEFzc2V0OiBFZmZlY3RBc3NldCB8IG51bGwgPSBudWxsO1xyXG5cclxuICAgIHByb3RlY3RlZCBfaW5zdGFuY2VJRDogbnVtYmVyID0gLTE7XHJcblxyXG4gICAgLy8jcmVnaW9uIGVmZmVjdENvbG9yXHJcbiAgICBAcHJvcGVydHkoeyBncm91cDogeyBuYW1lOiBcIlNldHRlci9HZXR0ZXJcIiwgaWQ6IFwiMVwiIH0sIHR5cGU6IENvbG9yLCB0b29sdGlwOiBcIk15IENvbG9yXCIgfSlcclxuICAgIHB1YmxpYyBzZXQgZWZmZWN0Q29sb3IodmFsOiBDb2xvcikge1xyXG4gICAgICAgIHRoaXMuX2VmZmVjdENvbG9yID0gdmFsO1xyXG5cclxuICAgICAgICBpZiAoRURJVE9SX05PVF9JTl9QUkVWSUVXKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVmbGFzaFBhcmFtcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yZWZsYXNoUGFyYW1zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXQgZWZmZWN0Q29sb3IoKTogQ29sb3Ige1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lZmZlY3RDb2xvcjtcclxuICAgIH1cclxuXHJcbiAgICBAcHJvcGVydHlcclxuICAgIHByb3RlY3RlZCBfZWZmZWN0Q29sb3I6IENvbG9yID0gbmV3IENvbG9yKDI1NSwgMjU1LCAyNTUsIDI1NSk7XHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcblxyXG4gICAgLy8jcmVnaW9uIGlzMkRpbjNEXHJcbiAgICBAcHJvcGVydHkoeyBncm91cDogeyBuYW1lOiBcIlNldHRlci9HZXR0ZXJcIiwgaWQ6IFwiMVwiIH0sIHRvb2x0aXA6ICfnlbbkvb/nlKhSZW5kZXJSb290MkTmmYLkvb/nlKgnIH0pXHJcbiAgICBwdWJsaWMgc2V0IGlzMkRpbjNEKHZhbDogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuX2lzMkRpbjNEID0gdmFsO1xyXG5cclxuICAgICAgICBpZiAoRURJVE9SX05PVF9JTl9QUkVWSUVXKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdCh0aGlzLnBpeGVsc1VzYWdlKTtcclxuICAgICAgICAgICAgdGhpcy5yZWZsYXNoUGFyYW1zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJlZmxhc2hQYXJhbXMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCBpczJEaW4zRCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXMyRGluM0Q7XHJcbiAgICB9XHJcblxyXG4gICAgQHByb3BlcnR5XHJcbiAgICBwcm90ZWN0ZWQgX2lzMkRpbjNEOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcbiAgICAvLyNyZWdpb24gc2FtcGxlRnJvbVJUXHJcbiAgICBAcHJvcGVydHkoeyBncm91cDogeyBuYW1lOiBcIlNldHRlci9HZXR0ZXJcIiwgaWQ6IFwiMVwiIH0sIHRvb2x0aXA6ICfnlbZTcHJpdGXkvobmupBSZW5kZXJUZXh0dXJl5pmC5L2/55SoJyB9KVxyXG4gICAgcHVibGljIHNldCBzYW1wbGVGcm9tUlQodmFsOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5fc2FtcGxlRnJvbVJUID0gdmFsO1xyXG4gICAgICAgIHRoaXMucmVzZXRNYXRlcmlhbCh7XHJcbiAgICAgICAgICAgIGRlZmluZXM6IHtcclxuICAgICAgICAgICAgICAgIFNBTVBMRV9GUk9NX1JUOiB0aGlzLl9zYW1wbGVGcm9tUlQsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0IHNhbXBsZUZyb21SVCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2FtcGxlRnJvbVJUO1xyXG4gICAgfVxyXG5cclxuICAgIEBwcm9wZXJ0eVxyXG4gICAgcHJvdGVjdGVkIF9zYW1wbGVGcm9tUlQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8vI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgICAvLyNyZWdpb24gYWJzdHJhY3QgbWV0aG9kc1xyXG4gICAgLyoqXHJcbiAgICAgKiBAYWJzdHJhY3RcclxuICAgICAqIFJldHVybiB0aGUgY291bnQgb2YgdXNlZCBmbG9hdHMgb2YgdGhlIGVmZmVjdC5cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBmbG9hdFVzYWdlKCk6IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBhYnN0cmFjdCBcclxuICAgICAqIEdlbmVyYXRlIGEgVW5pb24ga2V5IGZvciB0aGUgZWZmZWN0LlxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0RWZmZWN0VW5pb25LZXkoKTogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGFic3RyYWN0XHJcbiAgICAgKiBVcGRhdGUgdGhlIGVmZmVjdCBwYXJhbWV0ZXJzLlxyXG4gICAgICovXHJcbiAgICAvLyBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlUGFyYW1zKGluZGV4OiBudW1iZXIsIHByb3BCdWZmZXI6IEZsb2F0MzJBcnJheSk6IHZvaWQ7XHJcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlUGFyYW1zKGlkeDogbnVtYmVyLCB0ZXh0dXJlV2lkdGg6IG51bWJlciwgcHJvcEJ1ZmZlcjogRmxvYXQzMkFycmF5KTogdm9pZDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBhYnN0cmFjdFxyXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgbWF0ZXJpYWwuXHJcbiAgICAgKiBAcmV0dXJucyBNYXRlcmlhbFxyXG4gICAgKi9cclxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBpbml0TWF0ZXJpYWwoKTogTWF0ZXJpYWw7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAYWJzdHJhY3RcclxuICAgICAqIFJlc2V0IHRoZSBtYXRlcmlhbC5cclxuICAgICAqIEByZXR1cm5zIHZvaWRcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIHJlc2V0TWF0ZXJpYWwobWF0SW5mbzogSU1hdGVyaWFsSW5mbyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmN1c3RvbU1hdGVyaWFsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VzdG9tTWF0ZXJpYWwuY29weSh0aGlzLmN1c3RvbU1hdGVyaWFsLCBtYXRJbmZvKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcblxyXG4gICAgLy8jcmVnaW9uIG1ldGhvZHNcclxuICAgIC8qKlxyXG4gICAgICogNOWAi2Zsb2F054K65LiA5YCLcGl4ZWzvvIzpnIDkvb/nlKjlub7lgItwaXhlbOaVuOmHj1xyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgZ2V0IHBpeGVsc1VzYWdlKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIE1hdGguY2VpbChNYXRoLmxvZyh0aGlzLmZsb2F0VXNhZ2UpIC8gTWF0aC5sb2coMikpKSAvIDQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNhbEJ1ZmZlckluZGV4KHg6IG51bWJlciwgeTogbnVtYmVyLCB3OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiAoeCArICh5ICogdykpICogNDtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaW5pdChwaXhlbHNVc2FnZTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgdW5pb25LZXkgPSB0aGlzLmdldEVmZmVjdFVuaW9uS2V5KCk7XHJcblxyXG4gICAgICAgIC8vIFN0ZXAxOiDlj5bnmoTnlbbliY3nmoRlZmZlY3RJbmRleFxyXG4gICAgICAgIGlmICghU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RNYXAuaGFzKHVuaW9uS2V5KSkge1xyXG4gICAgICAgICAgICBsb2coYGluaXQ6ICR7dW5pb25LZXl9IG5vdCBmb3VuZCwgY3JlYXRlIG5ldyBvbmVgKTtcclxuICAgICAgICAgICAgbGV0IGVmZmVjdERhdGE6IEVmZmVjdERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBbXSxcclxuICAgICAgICAgICAgICAgIHV1aWRzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgZWZmZWN0RGF0YS5kYXRhLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgbWF0OiBudWxsLFxyXG4gICAgICAgICAgICAgICAgcHJvcEJ1ZmZlcjogbnVsbCxcclxuICAgICAgICAgICAgICAgIHByb3BUZXh0dXJlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgaXNEaXJ0eTogZmFsc2UsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RNYXAuc2V0KHVuaW9uS2V5LCBlZmZlY3REYXRhKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGVmZmVjdERhdGEgPSBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdE1hcC5nZXQodW5pb25LZXkpITtcclxuXHJcbiAgICAgICAgdGhpcy5faW5zdGFuY2VJRCA9IGVmZmVjdERhdGEudXVpZHMuZmluZEluZGV4KCh2KSA9PiB2ID09PSB0aGlzLm5vZGUudXVpZCk7XHJcbiAgICAgICAgaWYgKHRoaXMuX2luc3RhbmNlSUQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlSUQgPSBlZmZlY3REYXRhLnV1aWRzLmZpbmRJbmRleCgodikgPT4gdiA9PT0gXCJcIik7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9pbnN0YW5jZUlEID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VJRCA9IGVmZmVjdERhdGEudXVpZHMucHVzaCh0aGlzLm5vZGUudXVpZCkgLSAxO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChlZmZlY3REYXRhLmRhdGEubGVuZ3RoIDwgTWF0aC5mbG9vcih0aGlzLl9pbnN0YW5jZUlEIC8gUFJPUF9URVhUVVJFX1NJWkUpICsgMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdERhdGEuZGF0YS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0OiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wQnVmZmVyOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wVGV4dHVyZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNEaXJ0eTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBlZmZlY3REYXRhLnV1aWRzW3RoaXMuX2luc3RhbmNlSURdID0gdGhpcy5ub2RlLnV1aWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGlkeCA9IE1hdGguZmxvb3IodGhpcy5faW5zdGFuY2VJRCAvIFBST1BfVEVYVFVSRV9TSVpFKTtcclxuICAgICAgICB0aGlzLmNvbG9yID0gbmV3IENvbG9yKHRoaXMuX2luc3RhbmNlSUQgJSBQUk9QX1RFWFRVUkVfU0laRSwgcGl4ZWxzVXNhZ2UsIFBST1BfVEVYVFVSRV9TSVpFLCAyNTUpO1xyXG5cclxuICAgICAgICAvLyBTdGVwMjog5Yid5aeL5YyWRWZmZWN0IHByb3BzXHJcbiAgICAgICAgaWYgKGVmZmVjdERhdGEuZGF0YVtpZHhdLm1hdCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBjb25zdCB3ID0gUFJPUF9URVhUVVJFX1NJWkU7XHJcbiAgICAgICAgICAgIGNvbnN0IGggPSBwaXhlbHNVc2FnZTtcclxuXHJcbiAgICAgICAgICAgIGxldCBwcm9wQnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheSh3ICogaCAqIDQpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGg7IHkrKykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB3OyB4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9ICh4ICsgKHkgKiB3KSkgKiA0O1xyXG4gICAgICAgICAgICAgICAgICAgIHByb3BCdWZmZXJbaW5kZXhdID0gMTtcclxuICAgICAgICAgICAgICAgICAgICBwcm9wQnVmZmVyW2luZGV4ICsgMV0gPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIHByb3BCdWZmZXJbaW5kZXggKyAyXSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvcEJ1ZmZlcltpbmRleCArIDNdID0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHByb3BzVGV4dHVyZSA9IG5ldyBUZXh0dXJlMkQoKTtcclxuICAgICAgICAgICAgcHJvcHNUZXh0dXJlLnNldEZpbHRlcnMoVGV4dHVyZTJELkZpbHRlci5ORUFSRVNULCBUZXh0dXJlMkQuRmlsdGVyLk5FQVJFU1QpO1xyXG4gICAgICAgICAgICBwcm9wc1RleHR1cmUucmVzZXQoe1xyXG4gICAgICAgICAgICAgICAgd2lkdGg6IHcsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IGgsXHJcbiAgICAgICAgICAgICAgICBmb3JtYXQ6IFRleHR1cmUyRC5QaXhlbEZvcm1hdC5SR0JBMzJGLFxyXG4gICAgICAgICAgICAgICAgbWlwbWFwTGV2ZWw6IDBcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBwcm9wc1RleHR1cmUudXBsb2FkRGF0YShwcm9wQnVmZmVyKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBtYXQgPSB0aGlzLmluaXRNYXRlcmlhbCgpO1xyXG4gICAgICAgICAgICBtYXQuc2V0UHJvcGVydHkoJ3Byb3BzVGV4dHVyZScsIHByb3BzVGV4dHVyZSk7XHJcblxyXG4gICAgICAgICAgICBlZmZlY3REYXRhLmRhdGFbaWR4XSA9IHtcclxuICAgICAgICAgICAgICAgIG1hdDogbWF0LFxyXG4gICAgICAgICAgICAgICAgcHJvcEJ1ZmZlcjogcHJvcEJ1ZmZlcixcclxuICAgICAgICAgICAgICAgIHByb3BUZXh0dXJlOiBwcm9wc1RleHR1cmUsXHJcbiAgICAgICAgICAgICAgICBpc0RpcnR5OiBmYWxzZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5jdXN0b21NYXRlcmlhbCA9IGVmZmVjdERhdGEuZGF0YVtpZHhdLm1hdDtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVmbGFzaFBhcmFtcygpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB1bmlvbktleSA9IHRoaXMuZ2V0RWZmZWN0VW5pb25LZXkoKTtcclxuICAgICAgICBjb25zdCBpZHggPSBNYXRoLmZsb29yKHRoaXMuX2luc3RhbmNlSUQgLyBQUk9QX1RFWFRVUkVfU0laRSk7XHJcbiAgICAgICAgY29uc3QgZWZmZWN0UHJvcHMgPSBTcHJpdGVFZmZlY3RCYXNlLl9zX2VmZmVjdE1hcC5nZXQodW5pb25LZXkpIS5kYXRhW2lkeF07XHJcblxyXG4gICAgICAgIC8vIFVwZGF0ZSB0aGUgZWZmZWN0IHBhcmFtZXRlcnMgZnJvbSB0aGUgREVSSVZFRCBjbGFzcy5cclxuICAgICAgICB0aGlzLnVwZGF0ZVBhcmFtcyh0aGlzLl9pbnN0YW5jZUlEICUgUFJPUF9URVhUVVJFX1NJWkUsIFBST1BfVEVYVFVSRV9TSVpFIC0gMSwgZWZmZWN0UHJvcHMucHJvcEJ1ZmZlciEpO1xyXG5cclxuICAgICAgICBpZiAoRURJVE9SX05PVF9JTl9QUkVWSUVXKSB7XHJcbiAgICAgICAgICAgIC8vIEluIEVkaXRvciBtb2RlLCB1cGxvYWQgdGhlIGRhdGEgZGlyZWN0bHkuXHJcbiAgICAgICAgICAgIGVmZmVjdFByb3BzLnByb3BUZXh0dXJlIS51cGxvYWREYXRhKGVmZmVjdFByb3BzLnByb3BCdWZmZXIhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIEluIFByZXZpZXcgbW9kZSwgd2FpdCBmb3IgdGhlIGxhdGVVcGRhdGUgdG8gdXBsb2FkIHRoZSBkYXRhLlxyXG4gICAgICAgICAgICBlZmZlY3RQcm9wcy5pc0RpcnR5ID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlj5blvpcgU3ByaXRlIOeahCBVViDmnIDlsI/jgIHmnIDlpKflgLzlj4rlr6zpq5hcclxuICAgICAqIEBwYXJhbSB1diBcclxuICAgICAqIEByZXR1cm5zIHZlYzQgKG1pblUsIG1pblYsIHdpZHRoLCBoZWlnaHQpXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBnZXRVVih1djogbnVtYmVyW10pOiBWZWM0IHtcclxuICAgICAgICBsZXQgbWluVSA9IE1hdGgubWluKHV2WzBdLCB1dlsyXSwgdXZbNF0sIHV2WzZdKTtcclxuICAgICAgICBsZXQgbWluViA9IE1hdGgubWluKHV2WzFdLCB1dlszXSwgdXZbNV0sIHV2WzddKTtcclxuXHJcbiAgICAgICAgbGV0IG1heFUgPSBNYXRoLm1heCh1dlswXSwgdXZbMl0sIHV2WzRdLCB1dls2XSk7XHJcbiAgICAgICAgbGV0IG1heFYgPSBNYXRoLm1heCh1dlsxXSwgdXZbM10sIHV2WzVdLCB1dls3XSk7XHJcblxyXG4gICAgICAgIGxldCB3aWR0aCA9IG1heFUgLSBtaW5VO1xyXG4gICAgICAgIGxldCBoZWlnaHQgPSBtYXhWIC0gbWluVjtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBWZWM0KG1pblUsIG1pblYsIHdpZHRoLCBoZWlnaHQpO1xyXG4gICAgfVxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG5cclxuICAgIC8vI3JlZ2lvbiBsaWZlIGN5Y2xlXHJcbiAgICBvbkxvYWQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIub25Mb2FkKCk7XHJcbiAgICAgICAgdGhpcy5pbml0KHRoaXMucGl4ZWxzVXNhZ2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0KCkge1xyXG4gICAgICAgIHRoaXMucmVmbGFzaFBhcmFtcygpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB1bmlvbktleSA9IHRoaXMuZ2V0RWZmZWN0VW5pb25LZXkoKTtcclxuICAgICAgICBjb25zdCBlZmZlY3REYXRhID0gU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RNYXAuZ2V0KHVuaW9uS2V5KSE7XHJcbiAgICAgICAgY29uc3QgaWR4ID0gZWZmZWN0RGF0YS51dWlkcy5maW5kSW5kZXgoKHYpID0+IHYgPT09IHRoaXMubm9kZS51dWlkKTtcclxuXHJcbiAgICAgICAgaWYgKGlkeCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgZXJyb3IoXCJFZmZlY3QgaW5kZXggaXMgbm90IGZvdW5kIVwiKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZUlEID0gLTE7XHJcbiAgICAgICAgICAgIGVmZmVjdERhdGEhLnV1aWRzW2lkeF0gPSBcIlwiO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsYXRlVXBkYXRlKGR0OiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB1bmlvbktleSA9IHRoaXMuZ2V0RWZmZWN0VW5pb25LZXkoKTtcclxuICAgICAgICBjb25zdCBlZmZlY3REYXRhID0gU3ByaXRlRWZmZWN0QmFzZS5fc19lZmZlY3RNYXAuZ2V0KHVuaW9uS2V5KSE7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkeCA9IE1hdGguZmxvb3IodGhpcy5faW5zdGFuY2VJRCAvIFBST1BfVEVYVFVSRV9TSVpFKTtcclxuICAgICAgICBjb25zdCBlZmZlY3RQcm9wcyA9IGVmZmVjdERhdGEuZGF0YVtpZHhdO1xyXG5cclxuICAgICAgICBpZiAoZWZmZWN0UHJvcHMuaXNEaXJ0eSkge1xyXG4gICAgICAgICAgICBlZmZlY3RQcm9wcy5wcm9wVGV4dHVyZSEudXBsb2FkRGF0YShlZmZlY3RQcm9wcy5wcm9wQnVmZmVyISk7XHJcbiAgICAgICAgICAgIGVmZmVjdFByb3BzLmlzRGlydHkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=